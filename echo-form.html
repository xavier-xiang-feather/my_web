<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Echo Form Test</title>
</head>
<body>
  <h1>Echo Form Test</h1>

  <form id="echoForm">
    <label>Language</label><br>
    <select id="language">
      <option value="python">Python</option>
      <option value="php">PHP</option>
      <option value="c">C</option>
    </select><br><br>

    <label>HTTP Method</label><br>
    <select id="method">
      <option>GET</option>
      <option>POST</option>
      <option>PUT</option>
      <option>DELETE</option>
    </select><br><br>

    <label>Encoding</label><br>
    <select id="encoding">
      <option value="form">x-www-form-urlencoded</option>
      <option value="json">application/json</option>
    </select><br><br>

    <label>Message</label><br>
    <input type="text" id="message" value="Hello Echo"><br><br>

    <label>Count</label><br>
    <input type="number" id="count" value="1"><br><br>

    <button type="submit">Send Request</button>
  </form>

  <script>
  document.getElementById("echoForm").addEventListener("submit", function (e) {
    e.preventDefault();

    const lang = document.getElementById("language").value;
    const method = document.getElementById("method").value;
    const encoding = document.getElementById("encoding").value;
    const message = document.getElementById("message").value;
    const count = document.getElementById("count").value;

    const endpoints = {
      python: "/cgi-bin/echo-python-xijian.py",
      php:    "echo-php-xijian.php",
      c:      "/cgi-bin/echo-c-xijian"
    };

    const endpoint = endpoints[lang];
    if (!endpoint) {
      alert("Unknown language: " + lang);
      return;
    }

    let headers = {};
    let body = null;
    let url = endpoint;

    if (method === "GET") {
      url += `?message=${encodeURIComponent(message)}&count=${encodeURIComponent(count)}`;
    } else {
      if (encoding === "json") {
        headers["Content-Type"] = "application/json";
        body = JSON.stringify({ message, count });
      } else {
        headers["Content-Type"] = "application/x-www-form-urlencoded";
        body = `message=${encodeURIComponent(message)}&count=${encodeURIComponent(count)}`;
      }
    }

    fetch(url, { method, headers, body })
      .then(res => res.text())
      .then(text => {
        const w = window.open("", "_blank");
        if (!w) {
          alert("Popup 被浏览器拦截了：请允许弹窗，或我可以改成在本页显示结果。");
          return;
        }
        w.document.open();
        w.document.write(text);
        w.document.close();
      })
      .catch(err => {
        alert("Fetch error: " + err);
        console.error(err);
      });
  });
</script>

</body>
</html>
